@using System.Reflection
@using System.Collections.Concurrent
@inherits HeroiconBase

@if (_razorComponentType is not null)
{
    <DynamicComponent Type="_razorComponentType" Parameters="AdditionalAttributes"></DynamicComponent>
}
else
{
    <Blazor.Heroicons.Outline.QuestionMarkCircleIcon @attributes="AdditionalAttributes" />
}

@code {
    /// <summary>
    /// The type of icon. Default: <see cref="HeroiconType.Outline"/>.
    /// </summary>
    [Parameter]
    public HeroiconType Type { get; set; } = HeroiconType.Outline;
    private HeroiconType _heroiconType = HeroiconType.Outline;
    private Type? _razorComponentType;

    private static readonly ConcurrentDictionary<HeroiconType, Type[]> _iconTypeCache = new();

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        //check to see if the icon parameters have changed
        if (_razorComponentType is null || _heroiconType != Type)
        {
            _heroiconType = Type;

            //get random icon
            _razorComponentType = GetRandomIcon(Type);
        }
    }

    private static Type? GetRandomIcon(HeroiconType type)
    {
        var componentTypes = _iconTypeCache.GetOrAdd(type, t =>
            Assembly.GetExecutingAssembly().GetTypes()
                .Where(ct => ct.IsClass && ct.Namespace == $"Blazor.Heroicons.{t}")
                .ToArray());

        if (componentTypes.Length == 0)
            return null;

        return componentTypes[Random.Shared.Next(componentTypes.Length)];
    }

}