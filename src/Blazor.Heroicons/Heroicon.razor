@using System.Collections.Concurrent
@using System.Diagnostics.CodeAnalysis
@inherits HeroiconBase
@if (_razorComponentType is not null)
{
    <DynamicComponent Type="_razorComponentType" Parameters="@(AdditionalAttributes.ToDictionary(k => k.Key, v => v.Value))"></DynamicComponent>
}
else
{
    <Blazor.Heroicons.Outline.QuestionMarkCircleIcon @attributes="AdditionalAttributes" />
}

@code {
    /// <summary>
    /// The name of the icon. Default: <see cref="HeroiconName.Sparkles"/>.
    /// </summary>
    [Parameter] public string Name { get; set; } = HeroiconName.Sparkles;

    /// <summary>
    /// The type of icon. Default: <see cref="HeroiconType.Outline"/>.
    /// </summary>
    [Parameter] public HeroiconType Type { get; set; } = HeroiconType.Outline;

    private static readonly ConcurrentDictionary<string, Type?> _typeCache = new();

    private HeroiconType _heroiconType;
    private Type? _razorComponentType;

    [UnconditionalSuppressMessage("Trimming", "IL2057", Justification = "Icon component types are Razor components preserved by the SDK")]
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        //remove hyphens and spaces
        var name = Name.Replace("-", "").Replace(" ", "");
        //add icon suffix, if not included
        if (!name.EndsWith("icon", StringComparison.OrdinalIgnoreCase))
        {
            name = $"{name}Icon";
        }

        //check to see if the icon parameters have changed
        if (_razorComponentType is null ||
        !_razorComponentType.Name.Equals(name, StringComparison.OrdinalIgnoreCase) ||
        _heroiconType != Type)
        {
            //find icon based on name and type
            var key = $"Blazor.Heroicons.{Type}.{name}";
            _razorComponentType = _typeCache.GetOrAdd(key, k => System.Type.GetType(k, false, true));
            _heroiconType = Type;
        }
    }

}